<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>AlienZoo v0.1</title>
  <script src="//cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.js"></script>
  <script src="//cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>
  <style type="text/css">
    body {
      margin: 0;
    }
  </style>
</head>

<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
    integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>
  <script type="text/javascript">

    // *** start javascript part:  ***

    // *** set global variable subID and socket ***
    var subID

    var socket = io.connect('http://127.0.0.1:5000')

    // socket action: capture subID generated on server side
    socket.on('subID', function (sid) {
      console.log(sid)
      subID = sid
    })

    // configure phaser game
    var config = {
      type: Phaser.AUTO,
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
      },
      backgroundColor: '#ffffff',
      width: window.innerWidth, //1800, // 1280
      height: window.innerHeight, //1000, // 800
      physics: {
        default: 'arcade',
        arcade: {
          gravity: { y: 300 },
          debug: false
        }
      },
      scene: {
        init: init,
        preload: preload,
        create: create,
        update: update
      }
    };

    var game = new Phaser.Game(config);

    var buttonContainer;
    // variable for current Scene
    var currScene;
    // function to generate hex string for ID generation
    const genRanHex = size => [...Array(size)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');

    // *** set remaining global variables ***
    // plant counters
    let clickCountVar1 = 0;
    let clickCountVar2 = 0;
    let clickCountVar3 = 0;
    let clickCountVar4 = 0;
    let clickCountVar5 = 0;
    // plant counterfactual counters
    var cf_clickCountVar1;
    var cf_clickCountVar2;
    var cf_clickCountVar3;
    var cf_clickCountVar4;
    var cf_clickCountVar5;
    // min / max numbers of leaves to be fed
    let maxFeedingNo = 6;
    let minFeedingNo = 0;
    // numbers of Shubs
    let newNumber = 5; //Math.floor(Math.random() * 100);
    let oldNumber = newNumber;
    // button to start the Game
    var buttonStart;
    var buttonContinue;
    // button to get feedback
    var buttonFeedback;
    // button to get feedback
    var buttonFeed;
    // trial and block counters
    let trialCount = 0;
    let blockCount = 1;
    // arrays for storing user input / counterfactual information for later feedback
    let in_array = [];
    let cf_array = [];
    let diff_array = [];
    let shubOldNo = [];
    let shubNewNo = [];
    // initialize and shuffle array of plant names
    var plants = ['static/Leaf1_test.png', 'static/Leaf2_test.png', 'static/Leaf3_test.png', 'static/Leaf4_test.png', 'static/Leaf5_test.png'];
    // randomize plant colors per participant:
    plants = shuffle(plants);

    function init() {
      var canvas = this.sys.game.canvas;
      var fullscreen = this.sys.game.device.fullscreen;
      if (!fullscreen.available) {
        return;
      }
    }

    function preload() {
      // load all assets to display
      // stable scene assets
      this.load.image('stable', 'static/stable.png'); //,{ scale: 0.5 });
      this.load.spritesheet('shub', 'static/shub_spritesheet.png', { frameWidth: 50, frameHeight: 47 });

      // load button images
      this.load.image('buttonUp', 'static/buttonUp.png');
      this.load.image('buttonDown', 'static/buttonDown.png');
      this.load.image('buttonFeed', 'static/buttonSubmit.png');

      //load plant images
      this.load.image('plant1', plants[0]);
      this.load.image('plant2', plants[1]);
      this.load.image('plant3', plants[2]);
      this.load.image('plant4', plants[3]);
      this.load.image('plant5', plants[4]);

    }

    function create() {
      // set the start screen:
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.025, 'Welcome to the Alien Zoo!', { fontSize: '20px', color: '#000000' });
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.075, 'Your task today is to feed a pack of little aliens, the so-called Shubs:', { fontSize: '20px', color: '#000000' });

      this.add.sprite(window.innerWidth * 0.25, window.innerHeight * 0.175, 'shub', 0, { frameWidth: 50, frameHeight: 46 }).setScale(1.5);
      this.add.sprite(window.innerWidth * 0.50, window.innerHeight * 0.175, 'shub', 5, { frameWidth: 50, frameHeight: 47 }).setScale(1.5);
      this.add.sprite(window.innerWidth * 0.75, window.innerHeight * 0.175, 'shub', 8, { frameWidth: 50, frameHeight: 48 }).setScale(1.5);

      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.250, 'For feeding, you can select from 5 different plants:', { fontSize: '20px', color: '#000000' });

      this.add.image(window.innerWidth * 0.20, window.innerHeight * 0.350, 'plant1').setScale(0.15);
      this.add.image(window.innerWidth * 0.35, window.innerHeight * 0.350, 'plant2').setScale(0.15);
      this.add.image(window.innerWidth * 0.50, window.innerHeight * 0.350, 'plant3').setScale(0.15);
      this.add.image(window.innerWidth * 0.65, window.innerHeight * 0.350, 'plant4').setScale(0.15);
      this.add.image(window.innerWidth * 0.80, window.innerHeight * 0.350, 'plant5').setScale(0.15);

      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.425, 'Per round, you may feed up to 6 leaves per plant - any combination of plant leaves is possible.', { fontSize: '20px', color: '#000000' });
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.470, 'But beware: Not all plants might be good for our pack!', { fontSize: '20px', color: '#000000' });
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.525, 'If you have chosen a healthy combination, your pack size will increase.', { fontSize: '20px', color: '#000000' });
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.575, 'If you have chosen an unhealthy combination, your pack size will decrease.', { fontSize: '20px', color: '#000000' });
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.625, 'After three rounds, you will get an overview on your past choices.', { fontSize: '20px', color: '#000000' });
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.675, 'Af you are ready to start, hit the start button below.', { fontSize: '20px', color: '#000000' });

      // add button to start game and switch to fullscreen
      buttonStart = this.add.image(0, 0, 'buttonFeed').setScale(0.75)
        .setInteractive()
        .on('pointerdown', () => this.time.addEvent({ delay: 100, callback: stableScene, callbackScope: this }))
        .on('pointerdown', () => { window['game']['canvas'][game.device.fullscreen.request](); })
        .on('pointerdown', () => socket.emit('gameStartEvent', { data: 'User started game' }));

      var textStart = this.add.text(-55, -20, 'Start!', { fontSize: '30px', color: '#000000' }).setOrigin(0);
      var buttonContainer = this.add.container(window.innerWidth * 0.5, window.innerHeight * 0.85, [buttonStart, textStart])
    }

    function stableScene() {
      // increase trial count
      trialCount++;

      // *** get a clean slate ***
      this.children.removeAll();
      // disable all buttons to prevent undesired behaviour
      if (buttonStart.input.enabled) {
        buttonStart.disableInteractive();
      }
      if (typeof buttonContinue !== "undefined") {
        buttonContinue.disableInteractive();
      }
      if (typeof buttonFeedback !== "undefined") {
        buttonFeedback.disableInteractive();
      }

      // *** define variable values for a clean run ***
      let oldVar1 = clickCountVar1;
      let oldVar2 = clickCountVar2;
      let oldVar3 = clickCountVar3;
      let oldVar4 = clickCountVar4;
      let oldVar5 = clickCountVar5;
      clickCountVar1 = 0;
      clickCountVar2 = 0;
      clickCountVar3 = 0;
      clickCountVar4 = 0;
      clickCountVar5 = 0;

      // *** Upper content of window ***
      if (trialCount == 1) {
        this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.025, 'Welcome to your first run!', { fontSize: '20px', color: '#000000' });
        this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.075, 'Please make your first selection with the buttons on the right.', { fontSize: '20px', color: '#000000' });
        this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.125, 'Submit by hitting the button on the bottom right.', { fontSize: '20px', color: '#000000' });
      } else {
        shubText = this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.025, 'Your pack now consists of ' + newNumber + ' Shubs. Before, it was ' + oldNumber + '.', { fontSize: '20px', color: '#000000' });
        feedText = this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.075, 'Last round, you have fed them:', { fontSize: '20px', color: '#000000' });
        // display everything:
        this.add.image(window.innerWidth * 0.05, window.innerHeight * 0.175, 'plant1').setScale(0.15);
        this.add.text(window.innerWidth * 0.07, window.innerHeight * 0.175, 'x ' + oldVar1, { fontSize: '20px', color: '#000000' });
        this.add.image(window.innerWidth * 0.16, window.innerHeight * 0.175, 'plant2').setScale(0.15);
        this.add.text(window.innerWidth * 0.18, window.innerHeight * 0.175, 'x ' + oldVar2, { fontSize: '20px', color: '#000000' });
        this.add.image(window.innerWidth * 0.27, window.innerHeight * 0.175, 'plant3').setScale(0.15);
        this.add.text(window.innerWidth * 0.29, window.innerHeight * 0.175, 'x ' + oldVar3, { fontSize: '20px', color: '#000000' });
        this.add.image(window.innerWidth * 0.38, window.innerHeight * 0.175, 'plant4').setScale(0.15);
        this.add.text(window.innerWidth * 0.40, window.innerHeight * 0.175, 'x ' + oldVar4, { fontSize: '20px', color: '#000000' });
        this.add.image(window.innerWidth * 0.49, window.innerHeight * 0.175, 'plant5').setScale(0.15);
        this.add.text(window.innerWidth * 0.51, window.innerHeight * 0.175, 'x ' + oldVar5, { fontSize: '20px', color: '#000000' });
      }

      // update old number of shubs
      oldNumber = newNumber;

      // show input functionality:

      // *** Right side of window (input plane) ***
      // create inputs / buttons for user input
      // add counters for plant
      this.clickCountTextVar1 = this.add.text(window.innerWidth * 0.725, window.innerHeight * 0.19, '0', { fontSize: '30px', color: '#000000' });
      // add counters for plant2
      this.clickCountTextVar2 = this.add.text(window.innerWidth * 0.8, window.innerHeight * 0.19, '0', { fontSize: '30px', color: '#000000' });
      // add counters for plant3
      this.clickCountTextVar3 = this.add.text(window.innerWidth * 0.875, window.innerHeight * 0.19, '0', { fontSize: '30px', color: '#000000' });
      // add counters for plant4
      this.clickCountTextVar4 = this.add.text(window.innerWidth * 0.7625, window.innerHeight * 0.54, '0', { fontSize: '30px', color: '#000000' });
      // add counters for plant5
      this.clickCountTextVar5 = this.add.text(window.innerWidth * 0.8375, window.innerHeight * 0.54, '0', { fontSize: '30px', color: '#000000' });

      //PLANT 1:
      this.add.image(window.innerWidth * 0.725, window.innerHeight * 0.05, 'plant1').setScale(0.20);
      // button up, plant 1
      const buttonUpVar1 = this.add.image(window.innerWidth * 0.725, window.innerHeight * 0.15, 'buttonUp').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar1.setText(`${Math.min(++clickCountVar1, maxFeedingNo)}`))
        .on('pointerdown', () => clickCountVar1 = Math.min(clickCountVar1, maxFeedingNo));
      //.on('pointerdown', () => this.clickCountVar1 = Math.min(clickCountVar1, maxFeedingNo));

      // button down, plant 1
      const buttonDownVar1 = this.add.image(window.innerWidth * 0.725, window.innerHeight * 0.27, 'buttonDown').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar1.setText(`${Math.max(--clickCountVar1, minFeedingNo)}`))
        .on('pointerdown', () => clickCountVar1 = Math.max(clickCountVar1, minFeedingNo));

      //PLANT 2:
      this.add.image(window.innerWidth * 0.8, window.innerHeight * 0.05, 'plant2').setScale(0.2);
      // button up, plant 2
      const buttonUpVar2 = this.add.image(window.innerWidth * 0.8, window.innerHeight * 0.15, 'buttonUp').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar2.setText(`${Math.min(++clickCountVar2, maxFeedingNo)}`))
        .on('pointerdown', () => clickCountVar2 = Math.min(clickCountVar2, maxFeedingNo));

      // button down, plant 2
      const buttonDownVar2 = this.add.image(window.innerWidth * 0.8, window.innerHeight * 0.27, 'buttonDown').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar2.setText(`${Math.max(--clickCountVar2, minFeedingNo)}`))
        .on('pointerdown', () => clickCountVar2 = Math.max(clickCountVar2, minFeedingNo));

      // PLANT 3:
      this.add.image(window.innerWidth * 0.875, window.innerHeight * 0.05, 'plant3').setScale(0.2);
      // button up, plant 3
      const buttonUpVar3 = this.add.image(window.innerWidth * 0.875, window.innerHeight * 0.15, 'buttonUp').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar3.setText(`${Math.min(++clickCountVar3, maxFeedingNo)}`))
        .on('pointerdown', () => clickCountVar3 = Math.min(clickCountVar3, maxFeedingNo));

      // button down, plant 3
      const buttonDownVar3 = this.add.image(window.innerWidth * 0.875, window.innerHeight * 0.27, 'buttonDown').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar3.setText(`${Math.max(--clickCountVar3, minFeedingNo)}`))
        .on('pointerdown', () => clickCountVar3 = Math.max(clickCountVar3, minFeedingNo));

      // PLANT 4:
      this.add.image(window.innerWidth * 0.7625, window.innerHeight * 0.4, 'plant4').setScale(0.2);
      // button up, plant 4
      const buttonUpVar4 = this.add.image(window.innerWidth * 0.7625, window.innerHeight * 0.5, 'buttonUp').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar4.setText(`${Math.min(++clickCountVar4, maxFeedingNo)}`))
        .on('pointerdown', () => clickCountVar4 = Math.min(clickCountVar4, maxFeedingNo));

      // button down, plant 4
      const buttonDownVar4 = this.add.image(window.innerWidth * 0.7625, window.innerHeight * 0.62, 'buttonDown').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar4.setText(`${Math.max(--clickCountVar4, minFeedingNo)}`))
        .on('pointerdown', () => clickCountVar4 = Math.max(clickCountVar4, minFeedingNo));

      // PLANT 5:
      this.add.image(window.innerWidth * 0.8375, window.innerHeight * 0.4, 'plant5').setScale(0.2);
      // button up, plant 5
      const buttonUpVar5 = this.add.image(window.innerWidth * 0.8375, window.innerHeight * 0.5, 'buttonUp').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar5.setText(`${Math.min(++clickCountVar5, maxFeedingNo)}`))
        .on('pointerdown', () => clickCountVar5 = Math.min(clickCountVar5, maxFeedingNo));

      // button down, plant 5
      const buttonDownVar5 = this.add.image(window.innerWidth * 0.8375, window.innerHeight * 0.62, 'buttonDown').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.clickCountTextVar5.setText(`${Math.max(--clickCountVar5, minFeedingNo)}`))
        .on('pointerdown', () => clickCountVar5 = Math.max(clickCountVar5, minFeedingNo));

      // add button to submit new input - change scene when pressed!
      buttonFeed = this.add.image(0, 0, 'buttonFeed').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.time.addEvent({ delay: 100, callback: progressScene, callbackScope: this }));
      var textFeed = this.add.text(-95, -20, 'Feeding time!', { fontSize: '25px', color: '#000000' });
      buttonContainer = this.add.container(window.innerWidth * 0.8, window.innerHeight - (buttonFeed.height), [buttonFeed, textFeed]);

      // *** Display stable and Shubs
      let stable = this.textures.get('stable').getSourceImage();
      this.add.image(window.innerWidth * 0.025, window.innerHeight - (stable.height * 0.75), 'stable').setOrigin(0).setScale(0.5);

      // define animated shubs (aka "sprites" in phaser terms)
      var shubs = {
        key: 'move',
        frames: this.anims.generateFrameNumbers('shub', { start: 0, end: 9, first: Phaser.Math.Between(0, 9) }),
        frameRate: 10,
        repeat: -1,
        repeatDelay: 10
      };

      // create animation
      this.anims.create(shubs);

      // distribute shubs on screen
      for (var i = 0; i < newNumber; i++) {
        var tmp = Phaser.Math.Between(0, 9)
        if (tmp < 5) {
          var x = Phaser.Math.Between(window.innerWidth * 0.04, stable.width * 0.475);//1160); //10, 1130
          var y = Phaser.Math.Between(window.innerHeight - (stable.height * 0.575), window.innerHeight - (stable.height * 0.43)); //300, 525
        } else {
          var x = Phaser.Math.Between(window.innerWidth * 0.04, stable.width * 0.45);//1110); //10, 1130
          var y = Phaser.Math.Between(window.innerHeight - stable.height * 0.425, window.innerHeight - (stable.height * 0.28)); //526, 750
        }
        var startPos = Phaser.Math.Between(0, 9);
        var thisShub = this.add.sprite(x, y, 'shub', startPos);
        //set the width of the sprite
        thisShub.displayWidth = 45;
        //scale evenly
        thisShub.scaleY = thisShub.scaleX;
        // animate current individual
        thisShub.anims.delayedPlay(Phaser.Math.Between(0, 100), 'move', startPos);
        if (Phaser.Math.Between(0, 1) == 1) {
          // some move backward for variation
          thisShub.anims.reverse();
        }
      }
    }

    // define scene that shows 'feeding in progress'
    function progressScene() {

      // clean slate:
      this.children.removeAll();

      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.05, 'Feeding in progress...', { fontSize: '20px', color: '#000000' });

      // add overview of current choice:
      this.add.image(window.innerWidth * 0.05, window.innerHeight * 0.175, 'plant1').setScale(0.15);
      this.add.text(window.innerWidth * 0.07, window.innerHeight * 0.175, 'x ' + clickCountVar1, { fontSize: '20px', color: '#000000' });
      this.add.image(window.innerWidth * 0.16, window.innerHeight * 0.175, 'plant2').setScale(0.15);
      this.add.text(window.innerWidth * 0.18, window.innerHeight * 0.175, 'x ' + clickCountVar2, { fontSize: '20px', color: '#000000' });
      this.add.image(window.innerWidth * 0.27, window.innerHeight * 0.175, 'plant3').setScale(0.15);
      this.add.text(window.innerWidth * 0.29, window.innerHeight * 0.175, 'x ' + clickCountVar3, { fontSize: '20px', color: '#000000' });
      this.add.image(window.innerWidth * 0.38, window.innerHeight * 0.175, 'plant4').setScale(0.15);
      this.add.text(window.innerWidth * 0.40, window.innerHeight * 0.175, 'x ' + clickCountVar4, { fontSize: '20px', color: '#000000' });
      this.add.image(window.innerWidth * 0.49, window.innerHeight * 0.175, 'plant5').setScale(0.15);
      this.add.text(window.innerWidth * 0.51, window.innerHeight * 0.175, 'x ' + clickCountVar5, { fontSize: '20px', color: '#000000' });

      // add three shubs as 'loading animation'
      var progShubs = {
        key: 'progMove',
        frames: this.anims.generateFrameNumbers('shub', { start: 0, end: 9, first: Phaser.Math.Between(0, 9) }),
        frameRate: 10,
        repeat: -1,
        repeatDelay: 10
      };

      // create animation
      this.anims.create(progShubs);

      // add three shubs
      var progShub1 = this.add.sprite(window.innerWidth * 0.40, window.innerHeight * 0.5, 'shub', 0);
      var progShub2 = this.add.sprite(window.innerWidth * 0.50, window.innerHeight * 0.5, 'shub', 0);
      var progShub3 = this.add.sprite(window.innerWidth * 0.60, window.innerHeight * 0.5, 'shub', 0);

      // scale them
      progShub1.displayWidth = 45;
      progShub2.displayWidth = 45;
      progShub3.displayWidth = 45;

      progShub1.scaleY = progShub1.scaleX;
      progShub2.scaleY = progShub2.scaleX;
      progShub3.scaleY = progShub3.scaleX;

      // animate them
      progShub1.anims.delayedPlay(0, 'progMove', 0);
      progShub2.anims.delayedPlay(0, 'progMove', 0);
      progShub3.anims.delayedPlay(0, 'progMove', 0);

      // update current scene
      currScene = this;
      // call function that computes the new shub number
      computeNewShubNo();

    }

    function stableSceneRequestFeedback() {
      // *** get a clean slate ***
      this.children.removeAll();
      // *** define variable values for a clean run ***
      let oldVar1 = clickCountVar1;
      let oldVar2 = clickCountVar2;
      let oldVar3 = clickCountVar3;
      let oldVar4 = clickCountVar4;
      let oldVar5 = clickCountVar5;

      // add feedback about last choice
      shubText = this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.025, 'Your pack now consists of ' + newNumber + ' Shubs. Before, it was ' + oldNumber + '.', { fontSize: '20px', color: '#000000' });
      feedText = this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.075, 'Last round, you have fed them:', { fontSize: '20px', color: '#000000' });

      this.add.image(window.innerWidth * 0.05, window.innerHeight * 0.175, 'plant1').setScale(0.15);
      this.add.text(window.innerWidth * 0.07, window.innerHeight * 0.175, 'x ' + oldVar1, { fontSize: '20px', color: '#000000' });
      this.add.image(window.innerWidth * 0.16, window.innerHeight * 0.175, 'plant2').setScale(0.15);
      this.add.text(window.innerWidth * 0.18, window.innerHeight * 0.175, 'x ' + oldVar2, { fontSize: '20px', color: '#000000' });
      this.add.image(window.innerWidth * 0.27, window.innerHeight * 0.175, 'plant3').setScale(0.15);
      this.add.text(window.innerWidth * 0.29, window.innerHeight * 0.175, 'x ' + oldVar3, { fontSize: '20px', color: '#000000' });
      this.add.image(window.innerWidth * 0.38, window.innerHeight * 0.175, 'plant4').setScale(0.15);
      this.add.text(window.innerWidth * 0.40, window.innerHeight * 0.175, 'x ' + oldVar4, { fontSize: '20px', color: '#000000' });
      this.add.image(window.innerWidth * 0.49, window.innerHeight * 0.175, 'plant5').setScale(0.15);
      this.add.text(window.innerWidth * 0.51, window.innerHeight * 0.175, 'x ' + oldVar5, { fontSize: '20px', color: '#000000' });

      // update number
      oldNumber = newNumber;

      // add button to request feedback
      buttonFeedback = this.add.image(0, 0, 'buttonFeed').setScale(0.5)
        .setInteractive()
        .on('pointerdown', () => this.time.addEvent({ delay: 100, callback: feedbackScene, callbackScope: this }));
      var textFeedback = this.add.text(-95, -20, 'Get overview!', { fontSize: '25px', color: '#000000' })
      buttonContainer = this.add.container(window.innerWidth * 0.8, window.innerHeight * 0.5, [buttonFeedback, textFeedback])

      // *** Display stable and Shubs
      let stable = this.textures.get('stable').getSourceImage();
      this.add.image(window.innerWidth * 0.025, window.innerHeight - (stable.height * 0.75), 'stable').setOrigin(0).setScale(0.5);

      // define animated shubs (aka "sprites" in phaser terms)
      var shubs = {
        key: 'move',
        frames: this.anims.generateFrameNumbers('shub', { start: 0, end: 9, first: Phaser.Math.Between(0, 9) }),
        frameRate: 10,
        repeat: -1,
        repeatDelay: 10
      };

      // create animation
      this.anims.create(shubs);

      // distribute shubs on screen
      for (var i = 0; i < newNumber; i++) {
        var tmp = Phaser.Math.Between(0, 9)
        if (tmp < 5) {
          var x = Phaser.Math.Between(window.innerWidth * 0.04, stable.width * 0.475);//1160); //10, 1130
          var y = Phaser.Math.Between(window.innerHeight - (stable.height * 0.575), window.innerHeight - (stable.height * 0.43)); //300, 525
        } else {
          var x = Phaser.Math.Between(window.innerWidth * 0.04, stable.width * 0.45);//1110); //10, 1130
          var y = Phaser.Math.Between(window.innerHeight - stable.height * 0.425, window.innerHeight - (stable.height * 0.28)); //526, 750
        }
        var startPos = Phaser.Math.Between(0, 9);
        var thisShub = this.add.sprite(x, y, 'shub', startPos);
        //set the width of the sprite
        thisShub.displayWidth = 45;
        //scale evenly
        thisShub.scaleY = thisShub.scaleX;
        // animate current individual
        thisShub.anims.delayedPlay(Phaser.Math.Between(0, 100), 'move', startPos);
        if (Phaser.Math.Between(0, 1) == 1) {
          // some move backward for variation
          thisShub.anims.reverse();
        }
      }
    }

    function feedbackScene() {
      // clean slate
      this.children.removeAll();
      // remove all buttons
      buttonFeed.disableInteractive();
      buttonFeedback.disableInteractive();

      // 1st round:
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.025, 'In round 1, you selected:', { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.05, window.innerHeight * 0.075, 'plant1').setScale(0.1);
      this.add.text(window.innerWidth * 0.07, window.innerHeight * 0.075, 'x ' + in_array[1][0], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.16, window.innerHeight * 0.075, 'plant2').setScale(0.1);
      this.add.text(window.innerWidth * 0.18, window.innerHeight * 0.075, 'x ' + in_array[1][1], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.27, window.innerHeight * 0.075, 'plant3').setScale(0.1);
      this.add.text(window.innerWidth * 0.29, window.innerHeight * 0.075, 'x ' + in_array[1][2], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.38, window.innerHeight * 0.075, 'plant4').setScale(0.1);
      this.add.text(window.innerWidth * 0.40, window.innerHeight * 0.075, 'x ' + in_array[1][3], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.49, window.innerHeight * 0.075, 'plant5').setScale(0.1);
      this.add.text(window.innerWidth * 0.51, window.innerHeight * 0.075, 'x ' + in_array[1][4], { fontSize: '18px', color: '#000000' });

      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.1250, 'Result:', { fontSize: '18px', color: '#000000' });
      this.add.text(window.innerWidth * 0.125, window.innerHeight * 0.1250, 'Before:', { fontSize: '18px', color: '#000000' });
      this.add.sprite(window.innerWidth * 0.225, window.innerHeight * 0.1250, 'shub', 0, { frameWidth: 50, frameHeight: 46 }).setScale(0.8);
      this.add.text(window.innerWidth * 0.250, window.innerHeight * 0.1250, 'x ' + shubOldNo[1], { fontSize: '18px', color: '#000000' });

      this.add.text(window.innerWidth * 0.325, window.innerHeight * 0.1250, 'After:', { fontSize: '18px', color: '#000000' });
      this.add.sprite(window.innerWidth * 0.425, window.innerHeight * 0.1250, 'shub', 0, { frameWidth: 50, frameHeight: 46 }).setScale(0.8);
      this.add.text(window.innerWidth * 0.450, window.innerHeight * 0.1250, 'x ' + shubNewNo[1], { fontSize: '18px', color: '#000000' });

      // 2nd round:
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.300, 'In round 2, you selected:', { fontSize: '18px', color: '#000000' });

      this.add.image(window.innerWidth * 0.05, window.innerHeight * 0.35, 'plant1').setScale(0.1);
      this.add.text(window.innerWidth * 0.07, window.innerHeight * 0.35, 'x ' + in_array[2][0], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.16, window.innerHeight * 0.35, 'plant2').setScale(0.1);
      this.add.text(window.innerWidth * 0.18, window.innerHeight * 0.35, 'x ' + in_array[2][1], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.27, window.innerHeight * 0.35, 'plant3').setScale(0.1);
      this.add.text(window.innerWidth * 0.29, window.innerHeight * 0.35, 'x ' + in_array[2][2], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.38, window.innerHeight * 0.35, 'plant4').setScale(0.1);
      this.add.text(window.innerWidth * 0.40, window.innerHeight * 0.35, 'x ' + in_array[2][3], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.49, window.innerHeight * 0.35, 'plant5').setScale(0.1);
      this.add.text(window.innerWidth * 0.51, window.innerHeight * 0.35, 'x ' + in_array[2][4], { fontSize: '18px', color: '#000000' });

      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.400, 'Result:', { fontSize: '18px', color: '#000000' });
      this.add.text(window.innerWidth * 0.125, window.innerHeight * 0.400, 'Before:', { fontSize: '18px', color: '#000000' });
      this.add.sprite(window.innerWidth * 0.225, window.innerHeight * 0.400, 'shub', 0, { frameWidth: 50, frameHeight: 46 }).setScale(0.8);
      this.add.text(window.innerWidth * 0.250, window.innerHeight * 0.400, 'x ' + shubOldNo[2], { fontSize: '18px', color: '#000000' });

      this.add.text(window.innerWidth * 0.325, window.innerHeight * 0.400, 'After:', { fontSize: '18px', color: '#000000' });
      this.add.sprite(window.innerWidth * 0.425, window.innerHeight * 0.400, 'shub', 0, { frameWidth: 50, frameHeight: 46 }).setScale(0.8);
      this.add.text(window.innerWidth * 0.450, window.innerHeight * 0.400, 'x ' + shubNewNo[2], { fontSize: '18px', color: '#000000' });

      // 3rd round:
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.575, 'In round 3, you selected:', { fontSize: '18px', color: '#000000' });

      this.add.image(window.innerWidth * 0.05, window.innerHeight * 0.625, 'plant1').setScale(0.1);
      this.add.text(window.innerWidth * 0.07, window.innerHeight * 0.625, 'x ' + in_array[3][0], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.16, window.innerHeight * 0.625, 'plant2').setScale(0.1);
      this.add.text(window.innerWidth * 0.18, window.innerHeight * 0.625, 'x ' + in_array[3][1], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.27, window.innerHeight * 0.625, 'plant3').setScale(0.1);
      this.add.text(window.innerWidth * 0.29, window.innerHeight * 0.625, 'x ' + in_array[3][2], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.38, window.innerHeight * 0.625, 'plant4').setScale(0.1);
      this.add.text(window.innerWidth * 0.40, window.innerHeight * 0.625, 'x ' + in_array[3][3], { fontSize: '18px', color: '#000000' });
      this.add.image(window.innerWidth * 0.49, window.innerHeight * 0.625, 'plant5').setScale(0.1);
      this.add.text(window.innerWidth * 0.51, window.innerHeight * 0.625, 'x ' + in_array[3][4], { fontSize: '18px', color: '#000000' });

      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.6750, 'Result:', { fontSize: '18px', color: '#000000' });
      this.add.text(window.innerWidth * 0.125, window.innerHeight * 0.6750, 'Before:', { fontSize: '18px', color: '#000000' });
      this.add.sprite(window.innerWidth * 0.225, window.innerHeight * 0.6750, 'shub', 0, { frameWidth: 50, frameHeight: 46 }).setScale(0.8);
      this.add.text(window.innerWidth * 0.250, window.innerHeight * 0.6750, 'x ' + shubOldNo[3], { fontSize: '18px', color: '#000000' });

      this.add.text(window.innerWidth * 0.325, window.innerHeight * 0.6750, 'After:', { fontSize: '18px', color: '#000000' });
      this.add.sprite(window.innerWidth * 0.425, window.innerHeight * 0.6750, 'shub', 0, { frameWidth: 50, frameHeight: 46 }).setScale(0.8);
      this.add.text(window.innerWidth * 0.450, window.innerHeight * 0.6750, 'x ' + shubNewNo[3], { fontSize: '18px', color: '#000000' });

      // last: empty arrays for new block
      in_array = [];
      cf_array = [];
      diff_array = [];

      // depending on block number:
      if (blockCount < 6) {
        // add button to request feedback
        buttonContinue = this.add.image(0, 0, 'buttonFeed').setScale(0.5)
          .setInteractive()
          .on('pointerdown', () => this.time.addEvent({ delay: 100, callback: stableScene, callbackScope: this }));
        var textContinue = this.add.text(-95, -20, 'Continue!', { fontSize: '25px', color: '#000000' })
        buttonContainer = this.add.container(window.innerWidth * 0.8, window.innerHeight * 0.5, [buttonContinue, textContinue])
      } else {
        // after 5 blocks, go to end scene
        buttonContinue = this.add.image(0, 0, 'buttonFeed').setScale(0.5)
          .setInteractive()
          .on('pointerdown', () => this.time.addEvent({ delay: 100, callback: endScene, callbackScope: this }));
        var textContinue = this.add.text(-95, -20, 'Continue!', { fontSize: '25px', color: '#000000' })
        buttonContainer = this.add.container(window.innerWidth * 0.8, window.innerHeight * 0.5, [buttonContinue, textContinue])
      }
    }

    // function to call the end scene
    function endScene() {
      this.children.removeAll();
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.05, 'Thank you for your work in the AlienZoo!', { fontSize: '20px', color: '#000000' });
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.10, 'To complete the study, please follow the link below and fill out the questionnaire.', { fontSize: '20px', color: '#000000' });
      this.add.text(window.innerWidth * 0.025, window.innerHeight * 0.15, '[INSERT LINK]', { fontSize: '20px', color: '#000000' });
    }

    // function to compute new shub number - strong interaction with server side!
    async function computeNewShubNo() {

      (async function () {

        // generate new promise
        const getNewShubNo = () => new Promise((resolve, reject) => {
          try {
            // send user input to server side
            socket.emit('predictNewShubNo', {
              var1: clickCountVar1, var2: clickCountVar2, var3: clickCountVar3, var4: clickCountVar4, var5: clickCountVar5, oN: oldNumber, tC: trialCount, bC: blockCount, subID: subID
            });
            // get new data back from server side
            socket.on('newShubNo', nSN => {
              // when info comes in, resolve promise
              resolve(nSN);
              console.log("Promise resolved now!!!")
            });
          } catch (e) {
            // catch error if something went wrong, reject promise
            return reject(e);
          }
        });

        // generate getNewShubNo asynchronously: wait for response from server
        const nSN = await getNewShubNo()

        // sanity check: log info coming from server
        console.log(nSN)

        // now, assign all necessary variables
        newNumber = nSN.SNnew;
        if (trialCount % 3 == 0) {
          idx = 3
        } else {
          idx = trialCount % 3
        }
        // assign new info to arrays
        in_array[idx] = [clickCountVar1, clickCountVar2, clickCountVar3, clickCountVar4, clickCountVar5]
        cf_array[idx] = [nSN.cf_var1, nSN.cf_var2, nSN.cf_var3, nSN.cf_var4, nSN.cf_var5];
        diff_array[idx] = [nSN.diff_var1, nSN.diff_var2, nSN.diff_var3, nSN.diff_var4, nSN.diff_var5];
        shubOldNo[idx] = oldNumber;
        shubNewNo[idx] = newNumber;
        cf_clickCountVar1 = nSN.cf_var1;
        cf_clickCountVar2 = nSN.cf_var2;
        cf_clickCountVar3 = nSN.cf_var3;
        cf_clickCountVar4 = nSN.cf_var4;
        cf_clickCountVar5 = nSN.cf_var5;
        // sanity check: log to be sure it works
        console.log(nSN)
        console.log(cf_array)
        console.log(diff_array)
        console.log("Trialno: " + trialCount);

        // update block count after info has been written and go to respective new Scene
        if (trialCount % 3 == 0) {
          blockCount++;
          currScene.time.addEvent({ delay: 1000, callback: stableSceneRequestFeedback, callbackScope: currScene });
        } else {
          currScene.time.addEvent({ delay: 1000, callback: stableScene, callbackScope: currScene });
        }
      }());
    }

    // auxilliary function to shuffle the plants-array right at the start
    function shuffle(array) {
      let counter = array.length;

      // While there are elements in the array
      while (counter > 0) {
        // Pick a random index
        let index = Math.floor(Math.random() * counter);

        // Decrease counter by 1
        counter--;

        // And swap the last element with it
        let temp = array[counter];
        array[counter] = array[index];
        array[index] = temp;
      }

      return array;
    }

    // phaser's update function
    // responsible for updating and re-drawing the game objects
    function update() {
    }

  // *** end javascript part ***
  </script>
</body>

</html>